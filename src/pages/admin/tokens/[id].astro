---
import BaseLayout from '../../../layouts/BaseLayout.astro'
import { getCollection } from 'astro:content'
import { getTokenById, isExpired, isRevoked } from '../../../server/codeAccessStore'
import { signCodeAccessToken } from '../../../server/codeAccessToken'

export const prerender = false

const { id } = Astro.params
if (!id) throw new Error('Missing token id')

const token = await getTokenById(id)
if (!token) {
  return Astro.redirect('/admin/tokens')
}

const signedToken = await signCodeAccessToken({ tokenId: token.id })
const projects = await getCollection('projects')
const projectOptions = projects.map((p) => ({
  slug: p.slug,
  title: p.data.title,
  samples:
    p.data.codeAccess?.samples?.map((s) => ({
      id: s.id,
      title: s.title,
      language: s.language,
    })) ?? [],
}))

const status = isRevoked(token)
  ? 'Revoked'
  : isExpired(token.expiresAt)
    ? 'Expired'
    : 'Active'
---

<BaseLayout title={`Admin — Token ${token.id}`} description="Edit code access token">
  <section class="mx-auto max-w-6xl px-4 py-10 sm:px-6">
    <div class="max-w-3xl">
      <a class="text-sm text-slate-300 hover:text-white" href="/admin/tokens">
        Back to tokens
      </a>

      <h1 class="mt-4 text-2xl font-semibold tracking-tight text-white sm:text-3xl">
        Edit token
      </h1>

      <div class="mt-6 rounded-xl border border-white/10 bg-white/5 p-6">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <div class="text-sm text-slate-300">Token id</div>
            <div class="mt-1 break-all font-mono text-sm text-white">{token.id}</div>
            <div class="mt-3 text-sm text-slate-300">Status</div>
            <div class="mt-1 text-sm font-semibold text-white">{status}</div>
          </div>
          <div class="sm:text-right">
            <div class="text-sm text-slate-300">Uses</div>
            <div class="mt-1 text-sm font-semibold text-white">{token.uses}</div>
            <div class="mt-3 text-sm text-slate-300">Last used</div>
            <div class="mt-1 text-sm font-semibold text-white">{token.lastUsedAt ?? '—'}</div>
          </div>
        </div>

        <div class="mt-6 rounded-lg border border-emerald-500/20 bg-emerald-900/10 p-4">
          <div class="text-sm font-semibold text-emerald-100">Access link</div>
          <div class="mt-2 break-all text-sm text-emerald-100/90" data-access-link>
            {signedToken}
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button
              type="button"
              class="rounded-md bg-white/10 px-3 py-2 text-xs font-semibold text-white hover:bg-white/15"
              data-copy-token
            >
              Copy signed token
            </button>
          </div>
          <p class="mt-3 text-xs text-slate-300">
            This value is the signed token only. Use it in a URL like:
            <span class="font-mono"> /portfolio/&lt;project&gt;?token=&lt;token&gt;</span>
          </p>
        </div>

        <form class="mt-6 grid gap-5" data-edit-form>
          <div>
            <label class="block text-sm font-semibold text-white" for="label">Label</label>
            <input
              id="label"
              name="label"
              type="text"
              value={token.label ?? ''}
              class="mt-2 w-full rounded-md border border-white/10 bg-black/40 px-3 py-2 text-sm text-white"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold text-white" for="expiresAt">Expires at</label>
            <input
              id="expiresAt"
              name="expiresAt"
              type="datetime-local"
              required
              class="mt-2 w-full rounded-md border border-white/10 bg-black/40 px-3 py-2 text-sm text-white"
            />
            <p class="mt-2 text-xs text-slate-300">
              Current expiry: <span class="font-semibold">{token.expiresAt}</span>
            </p>
          </div>

          <div>
            <div class="flex items-center justify-between gap-4">
              <label class="block text-sm font-semibold text-white">Project scopes</label>
              <button
                type="button"
                class="rounded-md bg-white/10 px-3 py-2 text-xs font-semibold text-white hover:bg-white/15"
                data-add-scope
              >
                Add project
              </button>
            </div>
            <div class="mt-3 grid gap-4" data-scope-list></div>
          </div>

          <div class="flex items-center gap-3">
            <input id="revoked" name="revoked" type="checkbox" class="h-4 w-4" checked={Boolean(token.revokedAt)} />
            <label class="text-sm font-semibold text-white" for="revoked">Revoked</label>
          </div>

          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="text-sm text-brown-100" role="status" aria-live="polite" data-edit-status></div>
            <div class="flex flex-wrap items-center gap-2">
              <button
                type="button"
                class="rounded-md bg-red-900/50 px-4 py-2 text-sm font-semibold text-red-100 hover:bg-red-900/70"
                data-open-delete
              >
                Delete
              </button>
              <button
                type="submit"
                class="rounded-md bg-brown-900/40 px-4 py-2 text-sm font-semibold text-brown-100 transition hover:bg-brown-900/60"
              >
                Save changes
              </button>
            </div>
          </div>
        </form>
      </div>

      <dialog
        class="w-[min(100vw-2rem,40rem)] rounded-xl border border-white/10 bg-slate-950 p-0 text-slate-100 backdrop:bg-black/70"
        aria-label="Confirm deletion"
        data-delete-dialog
      >
        <div class="border-b border-white/10 px-6 py-4">
          <h2 class="text-base font-semibold text-white">Delete token</h2>
        </div>
        <div class="px-6 py-5">
          <p class="text-sm text-slate-300">
            This will permanently delete the token. Any previously shared links will stop working.
          </p>
          <div class="mt-4 flex items-center justify-end gap-2">
            <button
              type="button"
              class="rounded-md bg-white/10 px-4 py-2 text-sm font-semibold text-white hover:bg-white/15"
              data-delete-cancel
            >
              Cancel
            </button>
            <button
              type="button"
              class="rounded-md bg-red-900/50 px-4 py-2 text-sm font-semibold text-red-100 hover:bg-red-900/70"
              data-delete-confirm
            >
              Delete
            </button>
          </div>
        </div>
      </dialog>

      <script
        type="module"
        define:vars={{
          tokenId: token.id,
          signedToken,
          tokenScopes: token.scopes,
          projects: projectOptions,
          expiresAt: token.expiresAt,
        }}
      >

        const statusEl = document.querySelector('[data-edit-status]')
        const form = document.querySelector('[data-edit-form]')
        const scopeList = document.querySelector('[data-scope-list]')
        const addScopeBtn = document.querySelector('[data-add-scope]')
        const deleteDialog = document.querySelector('[data-delete-dialog]')

        function setStatus(msg) {
          if (statusEl) statusEl.textContent = msg
        }

        function escapeHtml(str) {
          return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        }

        function escapeRegex(str) {
          return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
        }

        function highlightMatch(text, terms) {
          if (!terms.length) return escapeHtml(text)
          let result = escapeHtml(text)
          for (const term of terms) {
            const re = new RegExp(`(${escapeRegex(term)})`, 'gi')
            result = result.replace(re, '<strong class="text-brown-100">$1</strong>')
          }
          return result
        }

        function fuzzyMatch(text, terms) {
          const lower = text.toLowerCase()
          return terms.every((t) => lower.includes(t.toLowerCase()))
        }

        function projectOptionMarkup(selectedSlug) {
          return projects
            .map((p) => {
              const selected = p.slug === selectedSlug ? 'selected' : ''
              return `<option value="${p.slug}" ${selected}>${escapeHtml(p.title)} (${escapeHtml(p.slug)})</option>`
            })
            .join('')
        }

        function selectedSamplesMarkup(projectSlug, selectedIds) {
          if (!selectedIds.length) return ''
          const p = projects.find((x) => x.slug === projectSlug)
          const samples = p?.samples ?? []
          return `
            <div class="mb-2">
              <div class="text-xs font-semibold text-slate-300 mb-1">Selected (${selectedIds.length})</div>
              <div class="grid gap-1">
                ${selectedIds
                  .map((id) => {
                    const s = samples.find((x) => x.id === id)
                    if (!s) return ''
                    return `
                      <label class="flex items-start gap-3 rounded-lg border border-emerald-500/20 bg-emerald-900/10 px-3 py-2">
                        <input type="checkbox" value="${escapeHtml(s.id)}" class="mt-1" checked data-sample-checkbox />
                        <span class="min-w-0">
                          <span class="block text-sm font-semibold text-white">${escapeHtml(s.title)}</span>
                          <span class="block text-xs text-slate-300">${escapeHtml(s.id)} &bull; ${escapeHtml(s.language)}</span>
                        </span>
                      </label>
                    `
                  })
                  .filter(Boolean)
                  .join('')}
              </div>
            </div>
          `
        }

        function sampleCheckboxMarkup(projectSlug, selectedIds, searchQuery) {
          const p = projects.find((x) => x.slug === projectSlug)
          const samples = p?.samples ?? []
          if (!samples.length) {
            return `<div class="text-sm text-slate-300">No code samples configured for this project</div>`
          }
          const set = new Set(selectedIds)
          const terms = (searchQuery || '').trim().split(/\s+/).filter(Boolean)
          const filtered = samples.filter((s) => {
            if (set.has(s.id)) return false
            if (terms.length) return fuzzyMatch(`${s.title} ${s.id} ${s.language}`, terms)
            return true
          })
          if (!filtered.length) {
            return terms.length
              ? `<div class="text-sm text-slate-300">No samples match your search</div>`
              : ''
          }
          return filtered
            .map((s) => {
              return `
                <label class="flex items-start gap-3 rounded-lg border border-white/10 bg-black/30 px-3 py-2">
                  <input type="checkbox" value="${escapeHtml(s.id)}" class="mt-1" data-sample-checkbox />
                  <span class="min-w-0">
                    <span class="block text-sm font-semibold text-white">${highlightMatch(s.title, terms)}</span>
                    <span class="block text-xs text-slate-300">${highlightMatch(s.id, terms)} &bull; ${highlightMatch(s.language, terms)}</span>
                  </span>
                </label>
              `
            })
            .join('')
        }

        function normaliseInitialScopes(scopes) {
          const safe = Array.isArray(scopes) ? scopes : []
          const norm = safe
            .map((s) => ({
              projectSlug: typeof s?.projectSlug === 'string' ? s.projectSlug : '',
              sampleIds: Array.isArray(s?.sampleIds) ? s.sampleIds.map((x) => String(x)) : [],
            }))
            .filter((s) => s.projectSlug)
          if (norm.length > 0) return norm
          return projects.length > 0 ? [{ projectSlug: projects[0].slug, sampleIds: [] }] : []
        }

        let editScopes = normaliseInitialScopes(tokenScopes)

        function renderScopeSamples(row) {
          const idx = Number(row.getAttribute('data-index'))
          if (!Number.isFinite(idx)) return
          const scope = editScopes[idx]
          if (!scope) return
          const searchInput = row.querySelector('[data-sample-search]')
          const query = searchInput?.value || ''
          const wrap = row.querySelector('[data-scope-samples]')
          if (!wrap) return
          wrap.innerHTML = `
            ${selectedSamplesMarkup(scope.projectSlug, scope.sampleIds)}
            <div class="max-h-60 overflow-y-auto grid gap-2" data-scope-samples-list>
              ${sampleCheckboxMarkup(scope.projectSlug, scope.sampleIds, query)}
            </div>
          `
        }

        function renderScopeList() {
          if (!scopeList) return
          if (!projects.length) {
            scopeList.innerHTML = `<div class="text-sm text-slate-300">No projects found</div>`
            return
          }

          scopeList.innerHTML = editScopes
            .map((s, idx) => {
              return `
                <div class="rounded-xl border border-white/10 bg-black/20 p-4" data-scope-row data-index="${idx}">
                  <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <div class="w-full">
                      <label class="block text-sm font-semibold text-white">Project</label>
                      <select class="mt-2 w-full rounded-md border border-white/10 bg-black/40 px-3 py-2 text-sm text-white" data-scope-project>
                        ${projectOptionMarkup(s.projectSlug)}
                      </select>
                    </div>
                    <button type="button" class="mt-1 rounded-md bg-white/10 px-3 py-2 text-xs font-semibold text-white hover:bg-white/15" data-remove-scope>
                      Remove
                    </button>
                  </div>

                  <div class="mt-4">
                    <div class="text-sm font-semibold text-white">Allowed samples</div>
                    <input
                      type="text"
                      placeholder="Search samples…"
                      class="mt-2 w-full rounded-md border border-white/10 bg-black/40 px-3 py-2 text-sm text-white placeholder:text-slate-500"
                      data-sample-search
                    />
                    <div class="mt-2" data-scope-samples>
                      ${selectedSamplesMarkup(s.projectSlug, s.sampleIds)}
                      <div class="max-h-60 overflow-y-auto grid gap-2" data-scope-samples-list>
                        ${sampleCheckboxMarkup(s.projectSlug, s.sampleIds, '')}
                      </div>
                    </div>
                  </div>
                </div>
              `
            })
            .join('')
        }

        function readScopeSamples(row) {
          const idx = Number(row.getAttribute('data-index'))
          if (!Number.isFinite(idx)) return
          const projectSlug = row.querySelector('[data-scope-project]')?.value
          const sampleIds = Array.from(row.querySelectorAll('input[data-sample-checkbox]'))
            .filter((el) => el instanceof HTMLInputElement && el.checked)
            .map((el) => el.value)
          if (!projectSlug) return
          editScopes[idx] = { projectSlug, sampleIds }
        }

        scopeList?.addEventListener('change', (e) => {
          const target = e.target
          if (!(target instanceof HTMLElement)) return
          const row = target.closest('[data-scope-row]')
          if (!row) return

          if (target.matches('[data-scope-project]')) {
            const idx = Number(row.getAttribute('data-index'))
            if (Number.isFinite(idx)) {
              editScopes[idx] = { projectSlug: target.value, sampleIds: [] }
              const searchInput = row.querySelector('[data-sample-search]')
              if (searchInput) searchInput.value = ''
            }
            renderScopeSamples(row)
            return
          }

          if (target.matches('[data-sample-checkbox]')) {
            readScopeSamples(row)
            renderScopeSamples(row)
          }
        })

        scopeList?.addEventListener('input', (e) => {
          const target = e.target
          if (!(target instanceof HTMLElement)) return
          if (!target.matches('[data-sample-search]')) return
          const row = target.closest('[data-scope-row]')
          if (!row) return
          renderScopeSamples(row)
        })

        scopeList?.addEventListener('click', (e) => {
          const target = e.target
          if (!(target instanceof HTMLElement)) return
          const btn = target.closest('[data-remove-scope]')
          if (!btn) return
          const row = btn.closest('[data-scope-row]')
          if (!row) return
          const idx = Number(row.getAttribute('data-index'))
          if (!Number.isFinite(idx)) return
          editScopes.splice(idx, 1)
          if (editScopes.length === 0 && projects.length > 0) {
            editScopes = [{ projectSlug: projects[0].slug, sampleIds: [] }]
          }
          renderScopeList()
        })

        addScopeBtn?.addEventListener('click', () => {
          if (!projects.length) return
          editScopes.push({ projectSlug: projects[0].slug, sampleIds: [] })
          renderScopeList()
        })

        document.querySelector('[data-copy-token]')?.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(signedToken)
            setStatus('Copied')
          } catch {
            setStatus('Copy failed')
          }
        })

        const accessLinkEl = document.querySelector('[data-access-link]')
        if (accessLinkEl) {
          const scopeProjects = (Array.isArray(tokenScopes) ? tokenScopes : [])
            .map((s) => (typeof s?.projectSlug === 'string' ? s.projectSlug : ''))
            .filter((s) => s)

          if (scopeProjects.length > 0) {
            accessLinkEl.innerHTML = scopeProjects
              .map((slug) => {
                const url = `${location.origin}/portfolio/${slug}?token=${signedToken}`
                return `
                  <div class="mt-2 break-all">
                    <span class="text-xs font-semibold text-emerald-100/90">${escapeHtml(slug)}</span>
                    <div class="font-mono text-sm text-emerald-100/90">${escapeHtml(url)}</div>
                  </div>
                `
              })
              .join('')
          }
        }

        document.querySelector('[data-open-delete]')?.addEventListener('click', () => {
          deleteDialog?.showModal()
        })

        document.querySelector('[data-delete-cancel]')?.addEventListener('click', () => {
          deleteDialog?.close()
        })

        document.querySelector('[data-delete-confirm]')?.addEventListener('click', async () => {
          try {
            const res = await fetch(`/api/admin/tokens/${tokenId}`, { method: 'DELETE' })
            if (!res.ok) throw new Error('Delete failed')
            location.href = '/admin/tokens'
          } catch {
            setStatus('Delete failed')
            deleteDialog?.close()
          }
        })

        function localIsoFromUtc(iso) {
          const ms = Date.parse(iso)
          if (Number.isNaN(ms)) return ''
          const d = new Date(ms)
          const pad = (n) => String(n).padStart(2, '0')
          return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`
        }

        function utcIsoFromLocal(local) {
          const d = new Date(local)
          return d.toISOString()
        }

        const expiresInput = document.querySelector('input[name="expiresAt"]')
        if (expiresInput) {
          expiresInput.value = localIsoFromUtc(expiresAt)
        }

        renderScopeList()

        form?.addEventListener('submit', async (e) => {
          e.preventDefault()
          setStatus('Saving…')

          const fd = new FormData(form)
          const label = String(fd.get('label') ?? '').trim()
          const expiresLocal = String(fd.get('expiresAt') ?? '')
          const revoked = fd.get('revoked') === 'on'

          const scopes = Array.from(scopeList?.querySelectorAll('[data-scope-row]') ?? [])
            .map((row) => {
              const projectSlug = row.querySelector('[data-scope-project]')?.value
              const sampleIds = Array.from(row.querySelectorAll('input[data-sample-checkbox]'))
                .filter((el) => el instanceof HTMLInputElement && el.checked)
                .map((el) => el.value)
              return { projectSlug, sampleIds }
            })
            .map((s) => ({
              projectSlug: String(s.projectSlug || ''),
              sampleIds: Array.isArray(s.sampleIds) ? s.sampleIds : [],
            }))
            .filter((s) => s.projectSlug && s.sampleIds.length > 0)

          if (!expiresLocal || scopes.length === 0) {
            setStatus('Add at least one project scope with a sample selection')
            return
          }

          try {
            const res = await fetch(`/api/admin/tokens/${tokenId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                label,
                expiresAt: utcIsoFromLocal(expiresLocal),
                scopes,
                revokedAt: revoked ? new Date().toISOString() : null,
              }),
            })

            const data = await res.json().catch(() => ({}))
            if (!res.ok) throw new Error(data?.error || 'Save failed')

            setStatus('Saved')
          } catch (err) {
            setStatus(err instanceof Error ? err.message : 'Save failed')
          }
        })
      </script>
    </div>
  </section>
</BaseLayout>
